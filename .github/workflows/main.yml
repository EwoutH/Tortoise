name: build-and-test

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  GRAAL_HOME: /home/runner/.jabba/jdk/graalvm@20.0.0
  SBT_OPTS: -Dsbt.log.noformat=true

jobs:
  build:
    runs-on: ubuntu-latest
    if: ${{ 'pull_request' != github.event_name || (github.event.pull_request.head.repo.git_url != github.event.pull_request.base.repo.git_url) }}
    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ github.token }}

      - uses: actions/checkout@v2

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      # Node.js setup should come after GraalVM setup as GraalVM includes a conflicting `node` binary
      # and we want the "regular" node version to "win".  -Jeremy B June 2021
      - uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Git Init
        run: git submodule update --init --recursive

      - name: Environment Info
        run: |
          ./sbt.sh version
          echo $PATH
          readlink -f `which node`
          node --version
          echo $JAVA_HOME
          readlink -f `which java`
          java -version
          readlink -f `which javac`
          javac -version

      - name: Lint
        run: |
          ./sbt.sh netLogoWeb/scalastyle compilerCore/scalastyle compilerJVM/scalastyle compilerJS/scalastyle macrosCore/scalastyle
          cd engine; yarn install; grunt coffeelint

      - name: Compile All
        run: |
          ./sbt.sh "compilerJVM / Test / compile"
          ./sbt.sh "compilerJS / Test / compile"
          ./sbt.sh "netLogoWeb / Test / compile"

      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

  test-compiler:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Compiler JVM Tests
        run: |
          ./sbt.sh "compilerJVM / Test / test"
          ./sbt.sh "compilerJVM / depend"

      - name: Compiler JS Tests
        run: |
          ./sbt.sh "compilerJS / Test / test"

  test-web:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: NetLogo Web Tests
        run: |
          ./sbt.sh "netLogoWeb / Test / runMain org.nlogo.tortoise.nlw.ExtensionsUpdater"
          ./sbt.sh "netLogoWeb / Test / fast"
          ./sbt.sh "netLogoWeb / Test / language"

  test-dumps:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model JS Dumps
        run: |
          ./sbt.sh "netLogoWeb/testOnly *ModelDumpTests"

  test-models-1:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 0 + 1
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 0 -z 1"

  test-models-2:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 2
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 2"

  test-models-3:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 3
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 3"

  test-models-4:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 4
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 4"

  test-models-5:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 5
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 5"

  test-models-6:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 6
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 6"

  test-models-7:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 7
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 7"

  test-models-8:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 8
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 8"

  test-models-9:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/cache@v2
        id: restore-build
        with:
          path: ./*
          key: ${{ github.sha }}

      - uses: olafurpg/setup-scala@v13
        with:
          java-version: graalvm@20.0.0

      - name: Model Docking Tests 9
        run: ./sbt.sh "netLogoWeb/testOnly *TestModels -- -z 9"
